name: Release Application

on:
    push:
        tags:
            - 'v*'

permissions:
    contents: write

jobs:
    build:
        name: Build Application for ${{ matrix.os }}-${{ matrix.runtime }}
        strategy:
            matrix:
                include:
                    -   os: windows-latest
                        runtime: win-x64
                    -   os: ubuntu-latest
                        runtime: linux-x64
        runs-on: ${{ matrix.os }}

        steps:
            -   name: Checkout Repository
                uses: actions/checkout@v4
                with:
                    submodules: recursive
                    fetch-depth: 0

            -   name: Extract .NET version from csproj
                id: dotnet
                run: |
                    dotnet_version=$(grep '<TargetFramework>' src/Polymerium.App/Polymerium.App.csproj | grep -o 'net[0-9]\+\.[0-9]\+' | sed 's/net//')
                    echo "dotnet_version=$dotnet_version" >> $GITHUB_OUTPUT
                    echo "dotnet_framework=net${dotnet_version}" >> $GITHUB_OUTPUT
                    if [ "${{ matrix.runtime }}" = "linux-x64" ]; then
                      echo "dotnet_version=$dotnet_version" > release.properties
                    fi
                shell: bash

            -   name: Setup .NET SDK
                uses: actions/setup-dotnet@v4
                with:
                    dotnet-version: ${{ steps.dotnet.outputs.dotnet_version }}

            -   name: Install GitVersion
                uses: gittools/actions/gitversion/setup@v3.2.1
                with:
                    versionSpec: '6.x'

            -   name: Determine Version
                id: gitversion
                uses: gittools/actions/gitversion/execute@v3.2.1
                with:
                    useConfigFile: true

            -   name: Install Velopack CLI
                run: dotnet tool install -g vpk

            -   name: Install git-cliff
                run: |
                    cargo install git-cliff

            -   name: Fix for dotnet publish
                run: |
                    if [ -d "src/Polymerium.App/bin/Release/${{ steps.dotnet.outputs.dotnet_framework }}/${{ matrix.runtime }}/publish/zh-hans" ]; then
                        echo "Renamed zh-hans folder to zh-Hans"
                        mv "src/Polymerium.App/bin/Release/${{ steps.dotnet.outputs.dotnet_framework }}/${{ matrix.runtime }}/publish/zh-hans" \
                           "src/Polymerium.App/bin/Release/${{ steps.dotnet.outputs.dotnet_framework }}/${{ matrix.runtime }}/publish/zh-Hans"
                    else
                        echo "Created zh-Hans folder"
                        mkdir -p "src/Polymerium.App/bin/Release/${{ steps.dotnet.outputs.dotnet_framework }}/${{ matrix.runtime }}/publish/zh-Hans"
                    fi
                shell: bash

            -   name: Publish Application
                run: |
                    dotnet publish -c Release --self-contained -r ${{ matrix.runtime }} src/Polymerium.App/Polymerium.App.csproj


            -   name: Determine Release Type
                id: get_version
                run: |
                    version="${{ steps.gitversion.outputs.semVer }}"
                    echo "version=$version" >> $GITHUB_OUTPUT

                    # Check if version contains prerelease tag or metadata
                    if [ "${{ steps.gitversion.outputs.preReleaseTag }}" != "" ] || [[ "$version" == *+* ]]; then
                        is_prerelease=true
                        release_name="v$version (Preview)"
                    else
                        is_prerelease=false
                        release_name="v$version"
                    fi
                    echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT
                    echo "release_name=$release_name" >> $GITHUB_OUTPUT
                    if [ "${{ matrix.runtime }}" = "linux-x64" ]; then
                      echo "is_prerelease=$is_prerelease" >> release.properties
                      echo "release_name=\"$release_name\"" >> release.properties
                    fi
                shell: bash

            -   name: Generate Changelog
                id: changelog
                run: |
                    version="${{ steps.gitversion.outputs.semVer }}"
                    git cliff --latest -o changelog.md
                    echo "changelog_file=changelog.md" >> $GITHUB_OUTPUT
                shell: bash

            -   name: Decide Executable Name
                id: exe_name
                run: |
                    if [ "${{ matrix.runtime }}" = "win-x64" ]; then
                        echo "exe_name=Polymerium.App.exe" >> $GITHUB_OUTPUT
                    else
                        echo "exe_name=Polymerium.App" >> $GITHUB_OUTPUT
                    fi
                shell: bash

            -   name: Pack with Velopack
                run: |
                    vpk download github --repoUrl https://github.com/${{ github.repository }}
                    vpk pack --runtime ${{ matrix.runtime }} --packId Polymerium --packVersion ${{ steps.get_version.outputs.version }} --packDir src/Polymerium.App/bin/Release/${{ steps.dotnet.outputs.dotnet_framework }}/${{ matrix.runtime }}/publish --releaseNotes changelog.md --mainExe ${{ steps.exe_name.outputs.exe_name }}

            -   name: Upload Build Artifact
                uses: actions/upload-artifact@v4
                with:
                    name: release-assets-${{ matrix.runtime }}
                    path: Releases

            -   name: Upload Release Metadata
                if: matrix.runtime == 'linux-x64'
                uses: actions/upload-artifact@v4
                with:
                    name: release-metadata
                    path: |
                        release.properties
                        changelog.md

    publish:
        name: Publish Release
        needs: build
        runs-on: ubuntu-latest
        steps:
            -   name: Download artifacts
                uses: actions/download-artifact@v4
                with:
                    path: ./artifacts

            -   name: Load release metadata
                id: metadata
                run: |
                    source ./artifacts/release-metadata/release.properties
                    echo "dotnet_version=$dotnet_version" >> $GITHUB_OUTPUT
                    echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT
                    echo "release_name=$release_name" >> $GITHUB_OUTPUT

            -   name: Setup .NET SDK
                uses: actions/setup-dotnet@v4
                with:
                    dotnet-version: ${{ steps.metadata.outputs.dotnet_version }}

            -   name: Install Velopack CLI
                run: dotnet tool install -g vpk

            -   name: Prepare release assets
                run: |
                    mkdir Releases
                    cp -r ./artifacts/release-assets-*/* ./Releases/
                    echo "Combined release assets:"
                    ls -R Releases

            -   name: Publish to GitHub Releases
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    pre_flag=""
                    if [ "${{ steps.metadata.outputs.is_prerelease }}" = "true" ]; then
                        pre_flag="--pre"
                    fi
                    vpk upload github --repoUrl https://github.com/${{ github.repository }} $pre_flag \
                      --releaseName "${{ steps.metadata.outputs.release_name }}" \
                      --tag "${{ github.ref_name }}" \
                      --token ${{ secrets.GITHUB_TOKEN }} \
                      --releaseNotesFile ./artifacts/release-metadata/changelog.md
                shell: bash
