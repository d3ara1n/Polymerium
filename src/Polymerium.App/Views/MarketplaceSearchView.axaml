<husk:Page xmlns="https://github.com/avaloniaui"
           xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
           xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
           xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
           xmlns:husk="https://github.com/d3ara1n/Huskui.Avalonia"
           xmlns:fi="clr-namespace:FluentIcons.Avalonia;assembly=FluentIcons.Avalonia"
           xmlns:icons="https://github.com/MahApps/IconPacks.Avalonia"
           xmlns:vm="using:Polymerium.App.ViewModels"
           xmlns:v="using:Polymerium.App.Views"
           xmlns:m="using:Polymerium.App.Models"
           xmlns:controls="clr-namespace:Polymerium.App.Controls"
           xmlns:collection="clr-namespace:System.Collections.Generic;assembly=System.Collections"
           xmlns:lang="https://github.com/d3ara1n/Polymerium/Languages"
           xmlns:fie="clr-namespace:FluentIcons.Avalonia.Markup;assembly=FluentIcons.Avalonia"
           ScrollViewer.VerticalScrollBarVisibility="Disabled"
           mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450" IsHeaderVisible="False"
           x:DataType="vm:MarketplaceSearchViewModel" Padding="0"
           x:Class="Polymerium.App.Views.MarketplaceSearchView" x:Name="Exhibition" Background="{x:Null}">
    <husk:Page.Resources>
        <MenuFlyout x:Key="ExhibitModpackButtonFlyout" x:DataType="m:ExhibitModel">
            <MenuItem Header="{x:Static lang:Resources.MarketplaceSearchView_OpenWebsiteMenuText}"
                      Command="{Binding $parent[v:MarketplaceSearchView].((vm:MarketplaceSearchViewModel)DataContext).OpenWebsiteCommand,FallbackValue={x:Null}}"
                      CommandParameter="{Binding}">
                <MenuItem.Icon>
                    <icons:PackIconLucide Kind="ExternalLink"
                                          Height="{StaticResource MediumFontSize}"
                                          Width="{StaticResource MediumFontSize}"
                                          VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <!-- <MenuItem Header="Save to Favorites"> -->
            <!--     <MenuItem.Icon> -->
            <!--         <icons:PackIconLucide Kind="Bookmark" -->
            <!--             Height="10" Width="10" -->
            <!--             VerticalAlignment="Center" /> -->
            <!--     </MenuItem.Icon> -->
            <!-- </MenuItem> -->
        </MenuFlyout>
    </husk:Page.Resources>
    <Panel>
        <Grid RowDefinitions="Auto,*">
            <StackPanel Grid.Row="0" Margin="8,8,8,0">
                <Border CornerRadius="6,6,0,0" Padding="24">
                    <Border.Background>
                        <ImageBrush Source="{Binding HeaderImage}" Stretch="Fill" Opacity="0.6" />
                    </Border.Background>
                    <Panel>
                        <StackPanel Spacing="12">
                            <StackPanel Orientation="Horizontal">
                                <Button Theme="{StaticResource GhostButtonTheme}"
                                        Command="{Binding $parent[husk:Frame].GoBackCommand}">
                                    <fi:SymbolIcon Symbol="ArrowLeft" FontSize="{StaticResource MediumFontSize}" />
                                </Button>
                                <TextBlock Text="{x:Static lang:Resources.MarketplaceSearchView_Title}"
                                           FontSize="{StaticResource LargeFontSize}"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                            <TextBlock Text="{x:Static lang:Resources.MarketplaceSearchView_Message}"
                                       TextWrapping="Wrap" Opacity="0.8" />
                        </StackPanel>
                    </Panel>
                </Border>
                <Border CornerRadius="0,0,6,6" Background="{StaticResource LayerBackgroundBrush}">
                    <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto,Auto,Auto" ColumnSpacing="6" Margin="8">
                        <ComboBox Grid.Column="0" ItemsSource="{Binding SelectedRepository.Versions}"
                                  SelectedItem="{Binding FilteredVersion,Mode=TwoWay}" PlaceholderText="Version">
                            <ComboBox.ItemTemplate>
                                <DataTemplate DataType="x:String">
                                    <TextBlock Text="{Binding}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <ComboBox Grid.Column="1" ItemsSource="{Binding SelectedRepository.Loaders}"
                                  SelectedItem="{Binding FilteredLoader,Mode=TwoWay}" PlaceholderText="Loader">
                            <ComboBox.ItemTemplate>
                                <DataTemplate DataType="m:LoaderBasicModel">
                                    <TextBlock Text="{Binding DisplayName}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <Button Grid.Column="2" Theme="{StaticResource OutlineButtonTheme}"
                                Command="{Binding ClearFiltersCommand}" Padding="12,0">
                            <fi:SymbolIcon Symbol="FilterDismiss" FontSize="{StaticResource MediumFontSize}" />
                        </Button>
                        <TextBox Grid.Column="3"
                                 Watermark="{x:Static lang:Resources.MarketplaceSearchView_SearchBarPlaceholder}"
                                 Text="{Binding QueryText,Mode=TwoWay}">
                            <TextBox.InnerRightContent>
                                <Button
                                    IsVisible="{Binding $parent[TextBox].Text,Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                    Command="{Binding $parent[TextBox].Clear}"
                                    Content="{fie:SymbolIcon Symbol=Dismiss,FontSize={StaticResource MediumFontSize}}"
                                    Foreground="{StaticResource ControlSecondaryForegroundBrush}" />
                            </TextBox.InnerRightContent>
                        </TextBox>
                        <ComboBox Grid.Column="4" ItemsSource="{Binding Repositories}"
                                  SelectedItem="{Binding SelectedRepository,Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate DataType="m:RepositoryBasicModel">
                                    <TextBlock Text="{Binding Name}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <Button Grid.Column="5" Classes="Primary" IsDefault="True" Padding="12,0"
                                Command="{Binding SearchCommand}"
                                IsEnabled="{Binding Exhibits.IsFetching,Converter={x:Static BoolConverters.Not},FallbackValue=False}">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <husk:SwitchPresenter VerticalAlignment="Center"
                                                      Value="{Binding Exhibits.IsFetching,Mode=OneWay,FallbackValue=True}"
                                                      TargetType="x:Boolean"
                                                      Height="{StaticResource MediumFontSize}"
                                                      Width="{StaticResource MediumFontSize}">
                                    <husk:SwitchCase Value="True">
                                        <husk:ProgressRing
                                            Theme="{StaticResource SolidProgressRingTheme}"
                                            IsIndeterminate="{Binding Exhibits.IsFetching,Mode=OneWay,FallbackValue=False}"
                                            StrokeWidth="2"
                                            TrackStrokeWidth="2"
                                            Background="{Binding  $parent[Button].Foreground}" />
                                    </husk:SwitchCase>
                                    <husk:SwitchCase Value="False">
                                        <icons:PackIconLucide Kind="Search" />
                                    </husk:SwitchCase>
                                </husk:SwitchPresenter>
                                <TextBlock Text="{x:Static lang:Resources.MarketplaceSearchView_SearchButtonText}"
                                           VerticalAlignment="Center" />
                                <husk:Tag Classes="Status" Content="{Binding Exhibits.Count,FallbackValue=0}"
                                          Background="{StaticResource LayerBackgroundBrush}"
                                          Foreground="{StaticResource ControlForegroundBrush}" />
                            </StackPanel>
                        </Button>
                        <TabStrip Grid.Column="6" Name="LayoutSelector"
                                  SelectedIndex="{Binding LayoutIndex,Mode=TwoWay}"
                                  Theme="{StaticResource SegmentedTabStripTheme}">
                            <TabStrip.ItemsSource>
                                <collection:List x:TypeArguments="m:ListTemplateCombinationModel">
                                    <m:ListTemplateCombinationModel
                                        Icon="LayoutList">
                                        <m:ListTemplateCombinationModel.ItemTemplate>
                                            <DataTemplate x:DataType="m:ExhibitModel">
                                                <controls:ExhibitModpackButton
                                                    ContextFlyout="{StaticResource ExhibitModpackButtonFlyout}"
                                                    Theme="{StaticResource ListExhibitModpackButtonTheme}"
                                                    Command="{Binding $parent[v:MarketplaceSearchView].((vm:MarketplaceSearchViewModel)DataContext).ViewModpackCommand,FallbackValue={x:Null}}"
                                                    CommandParameter="{Binding}" />
                                            </DataTemplate>
                                        </m:ListTemplateCombinationModel.ItemTemplate>
                                        <m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                            <ItemsPanelTemplate>
                                                <StackPanel Margin="8" Spacing="6" />
                                            </ItemsPanelTemplate>
                                        </m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                    </m:ListTemplateCombinationModel>
                                    <m:ListTemplateCombinationModel
                                        Icon="LayoutGrid">
                                        <m:ListTemplateCombinationModel.ItemTemplate>
                                            <DataTemplate x:DataType="m:ExhibitModel">
                                                <controls:ExhibitModpackButton
                                                    ContextFlyout="{StaticResource ExhibitModpackButtonFlyout}"
                                                    Theme="{StaticResource GridExhibitModpackButtonTheme}"
                                                    Command="{Binding $parent[v:MarketplaceSearchView].((vm:MarketplaceSearchViewModel)DataContext).ViewModpackCommand,FallbackValue={x:Null}}"
                                                    CommandParameter="{Binding}" />
                                            </DataTemplate>
                                        </m:ListTemplateCombinationModel.ItemTemplate>
                                        <m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                            <ItemsPanelTemplate>
                                                <husk:FlexWrapPanel ColumnSpacing="8" RowSpacing="8" Margin="8" />
                                            </ItemsPanelTemplate>
                                        </m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                        <m:ListTemplateCombinationModel.ItemContainerTheme>
                                            <ControlTheme TargetType="ContentPresenter">
                                                <Setter Property="MaxWidth" Value="396" />
                                                <Setter Property="MinWidth" Value="198" />
                                                <Setter Property="MaxHeight" Value="256" />
                                                <Setter Property="MinHeight" Value="128" />
                                            </ControlTheme>
                                        </m:ListTemplateCombinationModel.ItemContainerTheme>
                                    </m:ListTemplateCombinationModel>
                                </collection:List>
                            </TabStrip.ItemsSource>
                            <TabStrip.ItemTemplate>
                                <DataTemplate x:DataType="m:ListTemplateCombinationModel">
                                    <icons:PackIconLucide Kind="{Binding Icon}"
                                                          Height="{StaticResource MediumFontSize}"
                                                          Width="{StaticResource MediumFontSize}"
                                                          VerticalAlignment="Center" HorizontalAlignment="Center" />
                                </DataTemplate>
                            </TabStrip.ItemTemplate>
                        </TabStrip>
                    </Grid>
                </Border>
            </StackPanel>
            <Panel Grid.Row="1">
                <husk:InfiniteScrollView ItemsSource="{Binding Exhibits}"
                                         ItemTemplate="{Binding #LayoutSelector.((m:ListTemplateCombinationModel)SelectedItem).ItemTemplate,FallbackValue={x:Null}}"
                                         ItemsPanel="{Binding #LayoutSelector.((m:ListTemplateCombinationModel)SelectedItem).ItemsPanelTemplate,FallbackValue={x:Null}}"
                                         ItemContainerTheme="{Binding #LayoutSelector.((m:ListTemplateCombinationModel)SelectedItem).ItemContainerTheme,FallbackValue={x:Null}}">
                    <husk:InfiniteScrollView.PendingContent>
                        <StackPanel Margin="36" Spacing="6">
                            <husk:ProgressRing Width="20" Height="20"
                                               IsIndeterminate="{Binding Exhibits.IsFetching,Mode=OneWay,FallbackValue=False}"
                                               HorizontalAlignment="Center" ShowProgressText="False" />
                            <TextBlock Text="{x:Static lang:Resources.Shared_FetchingLabelText}"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </husk:InfiniteScrollView.PendingContent>
                </husk:InfiniteScrollView>
            </Panel>
        </Grid>
    </Panel>

    <husk:Page.Styles>
        <Style Selector=":loading Grid#FilterBar">
            <Setter Property="IsVisible" Value="False" />
        </Style>
    </husk:Page.Styles>
</husk:Page>
