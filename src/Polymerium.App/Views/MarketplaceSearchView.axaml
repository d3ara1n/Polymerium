<husk:Page
    x:Class="Polymerium.App.Views.MarketplaceSearchView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:collection="clr-namespace:System.Collections.Generic;assembly=System.Collections"
    xmlns:controls="clr-namespace:Polymerium.App.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:fi="clr-namespace:FluentIcons.Avalonia;assembly=FluentIcons.Avalonia"
    xmlns:fie="clr-namespace:FluentIcons.Avalonia.Markup;assembly=FluentIcons.Avalonia"
    xmlns:husk="https://github.com/d3ara1n/Huskui.Avalonia"
    xmlns:icons="https://github.com/MahApps/IconPacks.Avalonia"
    xmlns:lang="https://github.com/d3ara1n/Polymerium/Languages"
    xmlns:m="using:Polymerium.App.Models"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:v="using:Polymerium.App.Views"
    xmlns:vm="using:Polymerium.App.ViewModels"
    x:Name="Exhibition"
    Padding="0"
    d:DesignHeight="450"
    d:DesignWidth="800"
    x:DataType="vm:MarketplaceSearchViewModel"
    Background="{x:Null}"
    IsHeaderVisible="False"
    ScrollViewer.VerticalScrollBarVisibility="Disabled"
    mc:Ignorable="d">
    <husk:Page.Resources>
        <MenuFlyout
            x:Key="ExhibitModpackButtonFlyout"
            x:DataType="m:ExhibitModel">
            <MenuItem
                Command="{Binding $parent[v:MarketplaceSearchView].((vm:MarketplaceSearchViewModel)DataContext).OpenWebsiteCommand, FallbackValue={x:Null}}"
                CommandParameter="{Binding}"
                Header="{x:Static lang:Resources.MarketplaceSearchView_OpenWebsiteMenuText}">
                <MenuItem.Icon>
                    <icons:PackIconLucide
                        Width="{StaticResource MediumFontSize}"
                        Height="{StaticResource MediumFontSize}"
                        VerticalAlignment="Center"
                        Kind="ExternalLink" />
                </MenuItem.Icon>
            </MenuItem>
            <!-- <MenuItem Header="Save to Favorites"> -->
            <!--     <MenuItem.Icon> -->
            <!--  <icons:PackIconLucide Kind="Bookmark"  -->
            <!--  Height="10" Width="10"  -->
            <!--  VerticalAlignment="Center" />  -->
            <!--     </MenuItem.Icon> -->
            <!-- </MenuItem> -->
        </MenuFlyout>
    </husk:Page.Resources>
    <Panel>
        <Grid RowDefinitions="Auto,*">
            <StackPanel
                Grid.Row="0"
                Margin="8,8,8,0">
                <Border
                    Padding="24"
                    CornerRadius="6,6,0,0">
                    <Border.Background>
                        <ImageBrush
                            Opacity="0.6"
                            Source="{Binding HeaderImage}"
                            Stretch="Fill" />
                    </Border.Background>
                    <DockPanel HorizontalSpacing="12">
                        <Button
                            VerticalAlignment="Top"
                            Command="{Binding $parent[husk:Frame].GoBackCommand}"
                            DockPanel.Dock="Left"
                            Theme="{StaticResource GhostButtonTheme}">
                            <fi:SymbolIcon
                                HorizontalAlignment="Left"
                                FontSize="{StaticResource MediumFontSize}"
                                Symbol="ArrowLeft" />
                        </Button>
                        <StackPanel Spacing="8">
                            <TextBlock
                                VerticalAlignment="Center"
                                FontSize="{StaticResource LargeFontSize}"
                                Text="{x:Static lang:Resources.MarketplaceSearchView_Title}" />
                            <TextBlock
                                Opacity="0.8"
                                Text="{x:Static lang:Resources.MarketplaceSearchView_Message}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </DockPanel>
                </Border>
                <Border
                    Background="{StaticResource LayerBackgroundBrush}"
                    CornerRadius="0,0,6,6">
                    <Grid
                        Margin="8"
                        ColumnDefinitions="Auto,Auto,Auto,*,Auto,Auto,Auto"
                        ColumnSpacing="6">
                        <ComboBox
                            Grid.Column="0"
                            ItemsSource="{Binding SelectedRepository.Versions}"
                            PlaceholderText="Version"
                            SelectedItem="{Binding FilteredVersion, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate DataType="x:String">
                                    <TextBlock Text="{Binding}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <ComboBox
                            Grid.Column="1"
                            ItemsSource="{Binding SelectedRepository.Loaders}"
                            PlaceholderText="Loader"
                            SelectedItem="{Binding FilteredLoader, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate DataType="m:LoaderBasicModel">
                                    <TextBlock Text="{Binding DisplayName}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <Button
                            Grid.Column="2"
                            Padding="12,0"
                            Command="{Binding ClearFiltersCommand}"
                            Theme="{StaticResource OutlineButtonTheme}">
                            <fi:SymbolIcon
                                FontSize="{StaticResource MediumFontSize}"
                                Symbol="FilterDismiss" />
                        </Button>
                        <TextBox
                            Grid.Column="3"
                            Text="{Binding QueryText, Mode=TwoWay}"
                            Watermark="{x:Static lang:Resources.MarketplaceSearchView_SearchBarPlaceholder}">
                            <TextBox.InnerRightContent>
                                <Button
                                    IsVisible="{Binding $parent[TextBox].Text, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                    Command="{Binding $parent[TextBox].Clear}"
                                    Content="{fie:SymbolIcon Symbol=Dismiss,
                                                             FontSize={StaticResource MediumFontSize}}"
                                    Foreground="{StaticResource ControlSecondaryForegroundBrush}" />
                            </TextBox.InnerRightContent>
                        </TextBox>
                        <ComboBox
                            Grid.Column="4"
                            ItemsSource="{Binding Repositories}"
                            SelectedItem="{Binding SelectedRepository, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate DataType="m:RepositoryBasicModel">
                                    <TextBlock Text="{Binding Name}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <Button
                            Classes="Primary"
                            Grid.Column="5"
                            Padding="12,0"
                            IsEnabled="{Binding Exhibits.IsFetching, Converter={x:Static BoolConverters.Not}, FallbackValue=False}"
                            Command="{Binding SearchCommand}"
                            IsDefault="True">
                            <StackPanel
                                Orientation="Horizontal"
                                Spacing="6">
                                <husk:SwitchPresenter
                                    Width="{StaticResource MediumFontSize}"
                                    Height="{StaticResource MediumFontSize}"
                                    VerticalAlignment="Center"
                                    TargetType="x:Boolean"
                                    Value="{Binding Exhibits.IsFetching, Mode=OneWay, FallbackValue=True}">
                                    <husk:SwitchCase Value="True">
                                        <husk:ProgressRing
                                            Background="{Binding $parent[Button].Foreground}"
                                            IsIndeterminate="{Binding Exhibits.IsFetching, Mode=OneWay, FallbackValue=False}"
                                            StrokeWidth="2"
                                            Theme="{StaticResource SolidProgressRingTheme}"
                                            TrackStrokeWidth="2" />
                                    </husk:SwitchCase>
                                    <husk:SwitchCase Value="False">
                                        <icons:PackIconLucide Kind="Search" />
                                    </husk:SwitchCase>
                                </husk:SwitchPresenter>
                                <TextBlock
                                    VerticalAlignment="Center"
                                    Text="{x:Static lang:Resources.MarketplaceSearchView_SearchButtonText}" />
                                <husk:Tag
                                    Classes="Status"
                                    Background="{StaticResource LayerBackgroundBrush}"
                                    Content="{Binding Exhibits.Count, FallbackValue=0}"
                                    Foreground="{StaticResource ControlForegroundBrush}" />
                            </StackPanel>
                        </Button>
                        <TabStrip
                            Name="LayoutSelector"
                            Grid.Column="6"
                            SelectedIndex="{Binding LayoutIndex, Mode=TwoWay}"
                            Theme="{StaticResource SegmentedTabStripTheme}">
                            <TabStrip.ItemsSource>
                                <collection:List x:TypeArguments="m:ListTemplateCombinationModel">
                                    <m:ListTemplateCombinationModel Icon="LayoutList">
                                        <m:ListTemplateCombinationModel.ItemTemplate>
                                            <DataTemplate x:DataType="m:ExhibitModel">
                                                <controls:ExhibitModpackButton
                                                    Command="{Binding $parent[v:MarketplaceSearchView].((vm:MarketplaceSearchViewModel)DataContext).ViewModpackCommand, FallbackValue={x:Null}}"
                                                    CommandParameter="{Binding}"
                                                    ContextFlyout="{StaticResource ExhibitModpackButtonFlyout}"
                                                    Theme="{StaticResource ListExhibitModpackButtonTheme}" />
                                            </DataTemplate>
                                        </m:ListTemplateCombinationModel.ItemTemplate>
                                        <m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                            <ItemsPanelTemplate>
                                                <StackPanel
                                                    Margin="8"
                                                    Spacing="6" />
                                            </ItemsPanelTemplate>
                                        </m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                    </m:ListTemplateCombinationModel>
                                    <m:ListTemplateCombinationModel Icon="LayoutGrid">
                                        <m:ListTemplateCombinationModel.ItemTemplate>
                                            <DataTemplate x:DataType="m:ExhibitModel">
                                                <controls:ExhibitModpackButton
                                                    Command="{Binding $parent[v:MarketplaceSearchView].((vm:MarketplaceSearchViewModel)DataContext).ViewModpackCommand, FallbackValue={x:Null}}"
                                                    CommandParameter="{Binding}"
                                                    ContextFlyout="{StaticResource ExhibitModpackButtonFlyout}"
                                                    Theme="{StaticResource GridExhibitModpackButtonTheme}" />
                                            </DataTemplate>
                                        </m:ListTemplateCombinationModel.ItemTemplate>
                                        <m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                            <ItemsPanelTemplate>
                                                <husk:FlexWrapPanel
                                                    Margin="8"
                                                    ColumnSpacing="8"
                                                    RowSpacing="8" />
                                            </ItemsPanelTemplate>
                                        </m:ListTemplateCombinationModel.ItemsPanelTemplate>
                                        <m:ListTemplateCombinationModel.ItemContainerTheme>
                                            <ControlTheme TargetType="ContentPresenter">
                                                <Setter Property="MaxWidth" Value="396" />
                                                <Setter Property="MinWidth" Value="198" />
                                                <Setter Property="MaxHeight" Value="256" />
                                                <Setter Property="MinHeight" Value="128" />
                                            </ControlTheme>
                                        </m:ListTemplateCombinationModel.ItemContainerTheme>
                                    </m:ListTemplateCombinationModel>
                                </collection:List>
                            </TabStrip.ItemsSource>
                            <TabStrip.ItemTemplate>
                                <DataTemplate x:DataType="m:ListTemplateCombinationModel">
                                    <icons:PackIconLucide
                                        Width="{StaticResource MediumFontSize}"
                                        Height="{StaticResource MediumFontSize}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Kind="{Binding Icon}" />
                                </DataTemplate>
                            </TabStrip.ItemTemplate>
                        </TabStrip>
                    </Grid>
                </Border>
            </StackPanel>
            <Panel Grid.Row="1">
                <husk:InfiniteScrollView
                    ItemContainerTheme="{Binding #LayoutSelector.((m:ListTemplateCombinationModel)SelectedItem).ItemContainerTheme, FallbackValue={x:Null}}"
                    ItemTemplate="{Binding #LayoutSelector.((m:ListTemplateCombinationModel)SelectedItem).ItemTemplate, FallbackValue={x:Null}}"
                    ItemsPanel="{Binding #LayoutSelector.((m:ListTemplateCombinationModel)SelectedItem).ItemsPanelTemplate, FallbackValue={x:Null}}"
                    ItemsSource="{Binding Exhibits}">
                    <husk:InfiniteScrollView.PendingContent>
                        <StackPanel
                            Margin="36"
                            Spacing="6">
                            <husk:ProgressRing
                                Width="20"
                                Height="20"
                                HorizontalAlignment="Center"
                                IsIndeterminate="{Binding Exhibits.IsFetching, Mode=OneWay, FallbackValue=False}"
                                ShowProgressText="False" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                Text="{x:Static lang:Resources.Shared_FetchingLabelText}" />
                        </StackPanel>
                    </husk:InfiniteScrollView.PendingContent>
                </husk:InfiniteScrollView>
            </Panel>
        </Grid>
    </Panel>

    <husk:Page.Styles>
        <Style Selector=":loading Grid#FilterBar">
            <Setter Property="IsVisible" Value="False" />
        </Style>
    </husk:Page.Styles>
</husk:Page>
