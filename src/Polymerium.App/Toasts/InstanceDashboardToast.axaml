<husk:Toast xmlns="https://github.com/avaloniaui"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            xmlns:husk="https://github.com/d3ara1n/Huskui.Avalonia"
            xmlns:local="using:Polymerium.App.Toasts"
            xmlns:launching="clr-namespace:Trident.Core.Engines.Launching;assembly=Trident.Core"
            xmlns:fi="clr-namespace:FluentIcons.Avalonia;assembly=FluentIcons.Avalonia"
            xmlns:icons="https://github.com/MahApps/IconPacks.Avalonia"
            xmlns:fie="clr-namespace:FluentIcons.Avalonia.MarkupExtensions;assembly=FluentIcons.Avalonia"
            xmlns:m="clr-namespace:Polymerium.App.Models"
            xmlns:services="clr-namespace:Polymerium.App.Services"
            mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
            Header="Dashboard" Padding="0"
            x:Class="Polymerium.App.Toasts.InstanceDashboardToast"
            ScrollViewer.VerticalScrollBarVisibility="Disabled">
    <husk:Toast.Resources>
        <DataTemplate x:Key="ScrapTemplate" DataType="m:ScrapModel">
            <Grid ColumnDefinitions="Auto,Auto,*" ColumnSpacing="4">
                <!-- 时间戳 -->
                <TextBlock Grid.Column="0"
                           Text="{Binding Time, StringFormat=HH:mm:ss}"
                           FontFamily="Cascadia Code, Consolas, monospace"
                           Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                           VerticalAlignment="Center" />

                <!-- 来源标签 -->
                <Border Grid.Column="1"
                        Background="{StaticResource ControlTranslucentHalfBackgroundBrush}"
                        CornerRadius="2"
                        Padding="4,1"
                        VerticalAlignment="Center">
                    <Border.IsVisible>
                        <MultiBinding Converter="{x:Static BoolConverters.Or}">
                            <Binding Path="Thread" Converter="{x:Static StringConverters.IsNotNullOrEmpty}" />
                            <Binding Path="Sender" Converter="{x:Static StringConverters.IsNotNullOrEmpty}" />
                        </MultiBinding>
                    </Border.IsVisible>
                    <TextBlock FontFamily="Cascadia Code, Consolas, monospace"
                               FontSize="{StaticResource ExtraSmallFontSize}"
                               Foreground="{StaticResource ControlSecondaryForegroundBrush}">
                        <Run Text="[" />
                        <Run Text="{Binding Thread, FallbackValue=?}" />
                        <Run Text="/" />
                        <Run Text="{Binding Sender, FallbackValue=?}" />
                        <Run Text="]" />
                    </TextBlock>
                </Border>

                <!-- 消息内容 -->
                <TextBlock Grid.Column="2"
                           Text="{Binding Message}"
                           TextTrimming="CharacterEllipsis"
                           ToolTip.Tip="{Binding Message}"
                           VerticalAlignment="Center" />
            </Grid>
        </DataTemplate>
    </husk:Toast.Resources>
    <Grid RowDefinitions="*,0,Auto">
        <Border Grid.Row="0">
            <ScrollViewer x:Name="Viewer" Margin="0,72,0,0">
                <ItemsControl ItemsSource="{Binding $parent[local:InstanceDashboardToast].Bindable}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="m:ScrapModel">
                            <husk:SwitchPresenter
                                Value="{Binding Level}"
                                TargetType="launching:ScrapLevel">
                                <!-- Information 级别 -->
                                <husk:SwitchCase Value="Information">
                                    <Border BorderBrush="{StaticResource ControlBorderBrush}"
                                            BorderThickness="3,0,0,0"
                                            Background="{StaticResource ControlTranslucentHalfBackgroundBrush}"
                                            Padding="8,1">
                                        <ContentControl Content="{Binding}"
                                                        ContentTemplate="{StaticResource ScrapTemplate}" />
                                    </Border>
                                </husk:SwitchCase>
                                <!-- Warning 级别 -->
                                <husk:SwitchCase Value="Warning">
                                    <Border BorderBrush="{StaticResource ControlWarningBorderBrush}"
                                            BorderThickness="3,0,0,0"
                                            Background="{StaticResource ControlWarningTranslucentHalfBackgroundBrush}"
                                            Padding="8,1">
                                        <ContentControl Content="{Binding}"
                                                        ContentTemplate="{StaticResource ScrapTemplate}" />
                                    </Border>
                                </husk:SwitchCase>
                                <!-- Error 级别 -->
                                <husk:SwitchCase Value="Error">
                                    <Border BorderBrush="{StaticResource ControlDangerBorderBrush}"
                                            BorderThickness="3,0,0,0"
                                            Background="{StaticResource ControlDangerTranslucentHalfBackgroundBrush}"
                                            Padding="8,1">
                                        <ContentControl Content="{Binding}"
                                                        ContentTemplate="{StaticResource ScrapTemplate}" />
                                    </Border>
                                </husk:SwitchCase>
                            </husk:SwitchPresenter>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </ScrollViewer>
        </Border>
        <Grid Grid.Row="2" ColumnDefinitions="Auto,0,*,4,Auto" Margin="12">
            <TextBox Grid.Column="2" Watermark="Filter by content..."
                     Text="{Binding $parent[local:InstanceDashboardToast].FilterText,Mode=TwoWay}">
                <TextBox.InnerLeftContent>
                    <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal">
                            <icons:PackIconLucide Margin="10,0"
                                                  Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                  Kind="ListFilter" Height="{StaticResource MediumFontSize}"
                                                  VerticalAlignment="Center" />
                            <husk:Divider Orientation="Vertical" />
                        </StackPanel>
                    </StackPanel>
                </TextBox.InnerLeftContent>
                <TextBox.InnerRightContent>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock VerticalAlignment="Center" Margin="0,0,8,0">
                            <Run
                                Text="{Binding $parent[local:InstanceDashboardToast].Bindable.Count,Mode=OneWay,FallbackValue=0}" />
                            <Run Text="/" />
                            <Run
                                Text="{Binding Source={x:Static services:ScrapService.CAPACITY}}" />
                        </TextBlock>
                        <Button
                            IsVisible="{Binding $parent[TextBox].Text,Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            Command="{Binding $parent[TextBox].Clear}"
                            Content="{fie:SymbolIcon Symbol=Dismiss,FontSize={StaticResource MediumFontSize}}"
                            Foreground="{StaticResource ControlSecondaryForegroundBrush}" />
                    </StackPanel>
                </TextBox.InnerRightContent>
            </TextBox>
            <ToggleButton Grid.Column="4" Classes="Small"
                          IsChecked="{Binding $parent[local:InstanceDashboardToast].IsAutoScroll,Mode=TwoWay}">
                <fi:SymbolIcon Symbol="TextBoxAlignBottom" FontSize="{StaticResource LargeFontSize}" />
            </ToggleButton>
        </Grid>
    </Grid>
</husk:Toast>
