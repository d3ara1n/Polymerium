<husk:Modal
    x:Class="Polymerium.App.Modals.InstancePackageModal"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:Polymerium.App.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:fi="clr-namespace:FluentIcons.Avalonia;assembly=FluentIcons.Avalonia"
    xmlns:husk="https://github.com/d3ara1n/Huskui.Avalonia"
    xmlns:icons="https://github.com/MahApps/IconPacks.Avalonia"
    xmlns:lang="https://github.com/d3ara1n/Polymerium/Languages"
    xmlns:m="using:Polymerium.App.Models"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:modals="using:Polymerium.App.Modals"
    xmlns:trident="clr-namespace:Trident.Abstractions.Repositories.Resources;assembly=Trident.Abstractions"
    MinWidth="360"
    Margin="64"
    d:DesignHeight="600"
    d:DesignWidth="360"
    x:DataType="m:InstancePackageInfoModel"
    mc:Ignorable="d">
    <husk:ConstrainedBox AspectRatio="0.8">
        <Grid RowDefinitions="Auto,*,Auto" RowSpacing="12">
            <Border
                Grid.Row="0"
                Padding="12"
                Background="{StaticResource ControlTranslucentHalfBackgroundBrush}"
                CornerRadius="{StaticResource MediumCornerRadius}">
                <ToolTip.Tip>
                    <TextBlock Text="{Binding ProjectName, FallbackValue=Name}" />
                </ToolTip.Tip>
                <Grid
                    ColumnDefinitions="Auto,*"
                    ColumnSpacing="12"
                    RowDefinitions="*,*">
                    <Border
                        Grid.Row="0"
                        Grid.RowSpan="2"
                        Grid.Column="0"
                        Width="48"
                        Height="48"
                        CornerRadius="{StaticResource SmallCornerRadius}">
                        <Border.Background>
                            <ImageBrush Source="{Binding Thumbnail, FallbackValue={x:Null}}" />
                        </Border.Background>
                    </Border>
                    <TextBlock
                        Grid.Row="0"
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        FontSize="{StaticResource LargeFontSize}"
                        FontWeight="{StaticResource ControlStrongFontWeight}"
                        Text="{Binding ProjectName, FallbackValue=Project}" />
                    <StackPanel
                        Grid.Row="1"
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        Orientation="Horizontal"
                        Spacing="4">
                        <HyperlinkButton NavigateUri="{Binding Reference, FallbackValue={x:Null}}">
                            <ToolTip.Tip>
                                <StackPanel Spacing="2">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="4">
                                        <TextBlock
                                            Grid.Column="0"
                                            FontSize="{StaticResource SmallFontSize}"
                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                            Text="{x:Static lang:Resources.Shared_ExternalLinkLabelText}" />
                                        <fi:SymbolIcon
                                            Grid.Column="1"
                                            FontSize="{StaticResource MediumFontSize}"
                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                            Symbol="Open" />
                                    </Grid>
                                    <TextBlock Text="{Binding $parent[HyperlinkButton].NavigateUri}" />
                                </StackPanel>
                            </ToolTip.Tip>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="{Binding Label, FallbackValue=Label, Converter={x:Static husk:StringConverters.ToUpper}}" />
                                <fi:SymbolIcon FontSize="{StaticResource MediumFontSize}" Symbol="Open" />
                            </StackPanel>
                        </HyperlinkButton>
                    </StackPanel>
                </Grid>
            </Border>
            <TabControl
                Grid.Row="1"
                Padding="0,12"
                BorderBrush="{StaticResource ControlBorderBrush}"
                BorderThickness="0,1,0,0">
                <TabControl.Styles>
                    <Style Selector="TabItem">
                        <Setter Property="Margin" Value="0" />
                    </Style>
                </TabControl.Styles>
                <TabItem Header="{x:Static lang:Resources.InstancePackageModal_BasicsTabText}">
                    <TextBlock Text="{Binding Summary, FallbackValue=Summary}" TextWrapping="Wrap" />
                </TabItem>
                <TabItem Header="{x:Static lang:Resources.InstancePackageModal_TagsTabText}">
                    <Border
                        BorderBrush="{StaticResource ControlBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="{StaticResource SmallCornerRadius}">
                        <Grid RowDefinitions="Auto,*">
                            <Border
                                Grid.Row="0"
                                Background="{StaticResource ControlBackgroundBrush}"
                                CornerRadius="{Binding Source={StaticResource SmallCornerRadius}, Converter={x:Static husk:CornerRadiusConverters.Upper}}">
                                <Grid>
                                    <DockPanel Margin="6">
                                        <TextBlock
                                            Margin="4,0"
                                            VerticalAlignment="Center"
                                            DockPanel.Dock="Right"
                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}">
                                            <Run Text="/" />
                                            <Run Text="{Binding Owner.Tags.Count, FallbackValue=0}" />
                                        </TextBlock>
                                        <Button
                                            HorizontalAlignment="Left"
                                            Classes="Small"
                                            Command="{Binding $parent[modals:InstancePackageModal].AddTagCommand}"
                                            Theme="{StaticResource GhostButtonTheme}">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <fi:SymbolIcon FontSize="{Binding $parent[Button].FontSize}" Symbol="Add" />
                                                <TextBlock Text="{x:Static lang:Resources.InstancePackageModal_AddTagButtonText}" />
                                            </StackPanel>
                                        </Button>
                                    </DockPanel>
                                </Grid>
                            </Border>
                            <Panel Grid.Row="1">
                                <StackPanel
                                    VerticalAlignment="Center"
                                    IsVisible="{Binding Owner.Tags.Count, Converter={x:Static husk:NumberConverters.IsZero}, FallbackValue=True}"
                                    Spacing="8">
                                    <icons:PackIconLucide
                                        Width="{StaticResource ExtraLargeFontSize}"
                                        Height="{StaticResource ExtraLargeFontSize}"
                                        HorizontalAlignment="Center"
                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                        Kind="Tag" />
                                    <TextBlock
                                        HorizontalAlignment="Center"
                                        FontSize="{StaticResource LargeFontSize}"
                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                        Text="{x:Static lang:Resources.Shared_EmptyListLabelText}" />
                                </StackPanel>
                                <ItemsControl Margin="12" ItemsSource="{Binding Owner.Tags}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel ItemSpacing="6" LineSpacing="6" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="x:String">
                                            <Border
                                                Background="{StaticResource ControlAccentTranslucentFullBackgroundBrush}"
                                                BorderBrush="{StaticResource ControlAccentInteractiveBorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="{StaticResource SmallCornerRadius}">
                                                <DockPanel>
                                                    <Button
                                                        Padding="4,0"
                                                        Command="{Binding $parent[modals:InstancePackageModal].RemoveTagCommand}"
                                                        CommandParameter="{Binding}"
                                                        CornerRadius="{Binding Source={StaticResource SmallCornerRadius}, Converter={x:Static husk:CornerRadiusConverters.Right}}"
                                                        DockPanel.Dock="Right"
                                                        Theme="{StaticResource GhostButtonTheme}">
                                                        <fi:SymbolIcon
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Center"
                                                            FontSize="{Binding $parent[Button].FontSize}"
                                                            Symbol="Dismiss" />
                                                    </Button>
                                                    <TextBlock Margin="8,4,0,4" Text="{Binding}" />
                                                </DockPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Panel>
                        </Grid>
                    </Border>
                </TabItem>
                <TabItem Header="{x:Static lang:Resources.InstancePackageModal_VersionsTabText}">
                    <Grid RowDefinitions="Auto,*" RowSpacing="8">
                        <Border
                            Grid.Row="0"
                            Background="{StaticResource ControlTranslucentFullBackgroundBrush}"
                            CornerRadius="{StaticResource MediumCornerRadius}">
                            <ContentControl Content="{Binding Version, FallbackValue={x:Null}}">
                                <ContentControl.DataTemplates>
                                    <DataTemplate DataType="m:InstancePackageUnspecifiedVersionModel">
                                        <Grid
                                            Margin="6,12"
                                            HorizontalAlignment="Center"
                                            ColumnDefinitions="Auto,*"
                                            ColumnSpacing="12"
                                            RowDefinitions="*,*">
                                            <fi:SymbolIcon
                                                Grid.Row="0"
                                                Grid.RowSpan="2"
                                                Grid.Column="0"
                                                VerticalAlignment="Center"
                                                FontSize="{StaticResource ExtraLargeFontSize}"
                                                Symbol="Sparkle" />
                                            <TextBlock
                                                Grid.Row="0"
                                                Grid.Column="1"
                                                FontSize="{StaticResource LargeFontSize}"
                                                Text="{x:Static lang:Resources.InstancePackageModal_VersionBoxUnspecificTitle}" />
                                            <TextBlock
                                                Grid.Row="1"
                                                Grid.Column="1"
                                                FontSize="{StaticResource SmallFontSize}"
                                                Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                Text="{x:Static lang:Resources.InstancePackageModal_VersionBoxUnspecificSubtitle}" />
                                        </Grid>
                                    </DataTemplate>
                                    <DataTemplate DataType="m:InstancePackageVersionModel">
                                        <Grid Margin="3" ColumnDefinitions="*,Auto">
                                            <Border
                                                Grid.Column="0"
                                                Padding="12"
                                                Background="{StaticResource OverlaySolidBackgroundBrush}"
                                                CornerRadius="{StaticResource SmallCornerRadius}">
                                                <StackPanel>
                                                    <TextBlock
                                                        FontSize="{StaticResource SmallFontSize}"
                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                        Text="{x:Static lang:Resources.InstancePackageModal_VersionBoxLabelText}" />
                                                    <TextBlock Text="{Binding Name}" />
                                                </StackPanel>
                                            </Border>
                                            <Button
                                                Grid.Column="1"
                                                Margin="4,0,0,0"
                                                Padding="6"
                                                Classes="Small"
                                                Command="{Binding $parent[modals:InstancePackageModal].RemoveVersionCommand}"
                                                IsVisible="{Binding $parent[modals:InstancePackageModal].((m:InstancePackageInfoModel)DataContext).Owner.IsLocked, Converter={x:Static BoolConverters.Not}, FallbackValue=False}"
                                                Theme="{StaticResource GhostButtonTheme}">
                                                <fi:SymbolIcon FontSize="{StaticResource MediumFontSize}" Symbol="Dismiss" />
                                            </Button>
                                        </Grid>
                                    </DataTemplate>
                                </ContentControl.DataTemplates>
                            </ContentControl>
                        </Border>
                        <husk:SwitchPresenter
                            Grid.Row="1"
                            TargetType="x:Boolean"
                            Value="{Binding Owner.IsLocked}">
                            <husk:SwitchCase Value="True">
                                <StackPanel VerticalAlignment="Center" Spacing="8">
                                    <fi:SymbolIcon
                                        HorizontalAlignment="Center"
                                        FontSize="{StaticResource ExtraLargeFontSize}"
                                        Symbol="LockClosed" />
                                    <TextBlock
                                        HorizontalAlignment="Center"
                                        FontSize="{StaticResource LargeFontSize}"
                                        Text="{x:Static lang:Resources.InstancePackageModal_LockedVersionLabelText}" />
                                </StackPanel>
                            </husk:SwitchCase>
                            <husk:SwitchCase Value="False">
                                <!--  TabItem 不是 Lazy 的，导致 LazyContainer 就算不可见也会开始 Load  -->
                                <husk:LazyContainer Source="{Binding $parent[modals:InstancePackageModal].LazyVersions}">
                                    <husk:LazyContainer.SourceTemplate>
                                        <DataTemplate DataType="m:InstancePackageVersionCollection">
                                            <Grid RowDefinitions="Auto,*" RowSpacing="8">
                                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                                    <CheckBox
                                                        Grid.Column="0"
                                                        Content="{x:Static lang:Resources.InstancePackageModal_FilterLabelText}"
                                                        IsChecked="{Binding $parent[modals:InstancePackageModal].IsFilterEnabled, Mode=TwoWay}" />
                                                    <Button
                                                        Grid.Column="1"
                                                        Padding="6"
                                                        Command="{Binding #VersionBox.ScrollIntoView}"
                                                        CommandParameter="{Binding #VersionBox.SelectedIndex}"
                                                        Theme="{StaticResource OutlineButtonTheme}">
                                                        <icons:PackIconLucide
                                                            Width="{StaticResource MediumFontSize}"
                                                            Height="{StaticResource MediumFontSize}"
                                                            Kind="LocateFixed" />
                                                    </Button>
                                                </Grid>
                                                <ListBox
                                                    Name="VersionBox"
                                                    Grid.Row="1"
                                                    ItemsSource="{Binding}"
                                                    SelectedItem="{Binding $parent[modals:InstancePackageModal].SelectedVersionProxy, Mode=TwoWay, FallbackValue={x:Null}}">
                                                    <ListBox.ItemTemplate>
                                                        <DataTemplate DataType="m:InstancePackageVersionModel">
                                                            <StackPanel Spacing="4">
                                                                <DockPanel>
                                                                    <husk:SwitchPresenter
                                                                        DockPanel.Dock="Right"
                                                                        TargetType="trident:ReleaseType"
                                                                        Value="{Binding ReleaseTypeRaw, FallbackValue=Release}">
                                                                        <husk:SwitchCase Value="Release">
                                                                            <husk:Tag Classes="Success" CornerRadius="{StaticResource SmallCornerRadius}">
                                                                                <TextBlock Text="{x:Static lang:Resources.ReleaseType_Release}" />
                                                                            </husk:Tag>
                                                                        </husk:SwitchCase>
                                                                        <husk:SwitchCase Value="Beta">
                                                                            <husk:Tag Classes="Warning" CornerRadius="{StaticResource SmallCornerRadius}">
                                                                                <TextBlock Text="{x:Static lang:Resources.ReleaseType_Beta}" />
                                                                            </husk:Tag>
                                                                        </husk:SwitchCase>
                                                                        <husk:SwitchCase Value="Alpha">
                                                                            <husk:Tag Classes="Danger" CornerRadius="{StaticResource SmallCornerRadius}">
                                                                                <TextBlock Text="{x:Static lang:Resources.ReleaseType_Alpha}" />
                                                                            </husk:Tag>
                                                                        </husk:SwitchCase>
                                                                    </husk:SwitchPresenter>
                                                                    <husk:SwitchPresenter TargetType="x:Boolean" Value="{Binding IsCurrent, FallbackValue=False}">
                                                                        <husk:SwitchCase Value="True">
                                                                            <TextBlock Foreground="{StaticResource ControlAccentForegroundBrush}" Text="{Binding Name, FallbackValue=Display}" />
                                                                        </husk:SwitchCase>
                                                                        <husk:SwitchCase Value="False">
                                                                            <TextBlock Text="{Binding Name, FallbackValue=Display}" />
                                                                        </husk:SwitchCase>
                                                                    </husk:SwitchPresenter>
                                                                </DockPanel>
                                                                <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto" ColumnSpacing="4">
                                                                    <fi:SymbolIcon
                                                                        Grid.Column="0"
                                                                        FontSize="{StaticResource SmallFontSize}"
                                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                        Symbol="Flag" />
                                                                    <TextBlock
                                                                        Grid.Column="1"
                                                                        FontSize="{StaticResource SmallFontSize}"
                                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                        Text="{Binding CompatibleLoaders}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <fi:SymbolIcon
                                                                        Grid.Column="2"
                                                                        FontSize="{StaticResource SmallFontSize}"
                                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                        Symbol="Branch" />
                                                                    <TextBlock
                                                                        Grid.Column="3"
                                                                        FontSize="{StaticResource SmallFontSize}"
                                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                        Text="{Binding CompatibleVersions}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="4"
                                                                        Background="Transparent"
                                                                        FontSize="{StaticResource SmallFontSize}"
                                                                        Text="{Binding PublishedAt}"
                                                                        ToolTip.Tip="{Binding PublishedAtRaw}" />
                                                                </Grid>
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ListBox.ItemTemplate>
                                                </ListBox>
                                            </Grid>
                                        </DataTemplate>
                                    </husk:LazyContainer.SourceTemplate>
                                </husk:LazyContainer>
                            </husk:SwitchCase>
                        </husk:SwitchPresenter>
                    </Grid>
                </TabItem>
                <TabItem Header="{x:Static lang:Resources.InstancePackageModal_DependenciesTabText}">
                    <husk:LazyContainer Source="{Binding $parent[modals:InstancePackageModal].LazyDependencies}">
                        <husk:LazyContainer.SourceTemplate>
                            <DataTemplate DataType="m:InstancePackageDependencyCollection">
                                <Grid RowDefinitions="Auto,*" RowSpacing="12">
                                    <Border
                                        Grid.Row="0"
                                        Padding="4"
                                        Background="{StaticResource ControlTranslucentFullBackgroundBrush}"
                                        CornerRadius="{StaticResource MediumCornerRadius}">
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                            <TextBlock
                                                Grid.Column="0"
                                                Margin="8,0"
                                                VerticalAlignment="Center"
                                                Text="{x:Static lang:Resources.InstancePackageModal_OverviewLabelText}" />
                                            <Border
                                                Grid.Column="1"
                                                Padding="8,4"
                                                Background="{StaticResource OverlaySolidBackgroundBrush}"
                                                CornerRadius="{StaticResource SmallCornerRadius}">
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    FontSize="{StaticResource LargeFontSize}"
                                                    FontWeight="Bold">
                                                    <Run Foreground="{StaticResource ControlAccentForegroundBrush}" Text="{Binding StrongCount}" />
                                                    <Run Foreground="{StaticResource ControlSecondaryForegroundBrush}" Text=" / " />
                                                    <Run Text="{Binding Count}" />
                                                </TextBlock>
                                            </Border>
                                        </Grid>
                                    </Border>
                                    <Panel Grid.Row="1">
                                        <StackPanel
                                            VerticalAlignment="Center"
                                            IsVisible="{Binding Count, Converter={x:Static husk:NumberConverters.IsZero}, FallbackValue=True}"
                                            Spacing="8">
                                            <icons:PackIconLucide
                                                Width="{StaticResource ExtraLargeFontSize}"
                                                Height="{StaticResource ExtraLargeFontSize}"
                                                HorizontalAlignment="Center"
                                                Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                Kind="Eclipse" />
                                            <TextBlock
                                                HorizontalAlignment="Center"
                                                FontSize="{StaticResource LargeFontSize}"
                                                Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                Text="{x:Static lang:Resources.Shared_EmptyListLabelText}" />
                                        </StackPanel>
                                        <ScrollViewer>
                                            <ItemsControl ItemsSource="{Binding Mode=OneWay}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate x:DataType="m:InstancePackageDependencyModel">
                                                        <controls:InstancePackageDependencyButton
                                                            Command="{Binding $parent[modals:InstancePackageModal].ViewPackageCommand, Mode=OneWay}"
                                                            CommandParameter="{Binding}"
                                                            IsChecked="{Binding Installed, Converter={x:Static ObjectConverters.IsNotNull}}" />
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Panel>
                                </Grid>
                            </DataTemplate>
                        </husk:LazyContainer.SourceTemplate>
                    </husk:LazyContainer>
                </TabItem>
                <TabItem Header="{x:Static lang:Resources.InstancePackageModal_DependantsTabText}">
                    <husk:LazyContainer Source="{Binding $parent[modals:InstancePackageModal].LazyDependants}">
                        <husk:LazyContainer.SourceTemplate>
                            <DataTemplate DataType="m:InstancePackageDependencyCollection">
                                <Grid RowDefinitions="Auto,*" RowSpacing="12">
                                    <Border
                                        Grid.Row="0"
                                        Padding="4"
                                        Background="{StaticResource ControlTranslucentFullBackgroundBrush}"
                                        CornerRadius="{StaticResource MediumCornerRadius}">
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                            <TextBlock
                                                Grid.Column="0"
                                                Margin="8,0"
                                                VerticalAlignment="Center"
                                                Text="{x:Static lang:Resources.InstancePackageModal_OverviewLabelText}" />
                                            <Border
                                                Grid.Column="1"
                                                Padding="8,4"
                                                Background="{StaticResource OverlaySolidBackgroundBrush}"
                                                CornerRadius="{StaticResource SmallCornerRadius}">
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    FontSize="{StaticResource LargeFontSize}"
                                                    FontWeight="Bold">
                                                    <Run Foreground="{StaticResource ControlAccentForegroundBrush}" Text="{Binding StrongCount}" />
                                                    <Run Foreground="{StaticResource ControlSecondaryForegroundBrush}" Text=" / " />
                                                    <Run Text="{Binding Count}" />
                                                </TextBlock>
                                            </Border>
                                        </Grid>
                                    </Border>
                                    <Panel Grid.Row="1">
                                        <StackPanel
                                            VerticalAlignment="Center"
                                            IsVisible="{Binding Count, Converter={x:Static husk:NumberConverters.IsZero}, FallbackValue=True}"
                                            Spacing="8">
                                            <icons:PackIconLucide
                                                Width="{StaticResource ExtraLargeFontSize}"
                                                Height="{StaticResource ExtraLargeFontSize}"
                                                HorizontalAlignment="Center"
                                                Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                Kind="Eclipse" />
                                            <TextBlock
                                                HorizontalAlignment="Center"
                                                FontSize="{StaticResource LargeFontSize}"
                                                Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                Text="{x:Static lang:Resources.Shared_EmptyListLabelText}" />
                                        </StackPanel>
                                        <ScrollViewer>
                                            <ItemsControl ItemsSource="{Binding Mode=OneWay}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate x:DataType="m:InstancePackageDependencyModel">
                                                        <controls:InstancePackageDependencyButton
                                                            Command="{Binding $parent[modals:InstancePackageModal].ViewPackageCommand, Mode=OneWay}"
                                                            CommandParameter="{Binding}"
                                                            IsChecked="{Binding Installed, Converter={x:Static ObjectConverters.IsNotNull}}" />
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Panel>
                                </Grid>
                            </DataTemplate>
                        </husk:LazyContainer.SourceTemplate>
                    </husk:LazyContainer>
                </TabItem>
                <TabItem Header="{x:Static lang:Resources.InstancePackageModal_HistoryTabText}">
                    <husk:LazyContainer Source="{Binding $parent[modals:InstancePackageModal].LazyHistory}">
                        <husk:LazyContainer.SourceTemplate>
                            <DataTemplate DataType="m:InstancePackageModificationCollection">
                                <Panel>
                                    <StackPanel
                                        VerticalAlignment="Center"
                                        IsVisible="{Binding Count, Converter={x:Static husk:NumberConverters.IsZero}, FallbackValue={x:True}}"
                                        Spacing="8">
                                        <icons:PackIconLucide
                                            Width="{StaticResource ExtraLargeFontSize}"
                                            Height="{StaticResource ExtraLargeFontSize}"
                                            HorizontalAlignment="Center"
                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                            Kind="History" />
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            FontSize="{StaticResource LargeFontSize}"
                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                            Text="{x:Static lang:Resources.Shared_EmptyListLabelText}" />
                                    </StackPanel>
                                    <ScrollViewer IsVisible="{Binding Count, Converter={x:Static husk:NumberConverters.IsNonZero}, FallbackValue={x:False}}">
                                        <StackPanel Margin="{StaticResource CardContentMargin}">
                                            <husk:Tag Content="{x:Static lang:Resources.InstancePackageModal_NowTagText}" />
                                            <ItemsControl ItemsSource="{Binding}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="m:InstancePackageModificationModel">
                                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                                            <!--  Timeline indicator column  -->
                                                            <Grid Grid.Column="0" RowDefinitions="*,Auto,*">
                                                                <!--  Top connector line  -->
                                                                <Rectangle
                                                                    Grid.Row="0"
                                                                    Width="2"
                                                                    HorizontalAlignment="Center"
                                                                    Fill="{StaticResource ControlBorderBrush}" />

                                                                <!--  Action icon with colored background  -->
                                                                <husk:SwitchPresenter
                                                                    Grid.Row="1"
                                                                    TargetType="m:InstancePackageModificationKind"
                                                                    Value="{Binding Kind}">
                                                                    <husk:SwitchCase Value="AddUnversioned">
                                                                        <Border
                                                                            Width="32"
                                                                            Height="32"
                                                                            VerticalAlignment="Top"
                                                                            Background="{StaticResource ControlSuccessTranslucentHalfBackgroundBrush}"
                                                                            CornerRadius="16">
                                                                            <fi:SymbolIcon
                                                                                FontSize="{StaticResource MediumFontSize}"
                                                                                Foreground="{StaticResource ControlSuccessForegroundBrush}"
                                                                                Symbol="Add" />
                                                                        </Border>
                                                                    </husk:SwitchCase>
                                                                    <husk:SwitchCase Value="AddVersioned">
                                                                        <Border
                                                                            Width="32"
                                                                            Height="32"
                                                                            VerticalAlignment="Top"
                                                                            Background="{StaticResource ControlSuccessTranslucentHalfBackgroundBrush}"
                                                                            CornerRadius="16">
                                                                            <fi:SymbolIcon
                                                                                FontSize="{StaticResource MediumFontSize}"
                                                                                Foreground="{StaticResource ControlSuccessForegroundBrush}"
                                                                                Symbol="Add" />
                                                                        </Border>
                                                                    </husk:SwitchCase>
                                                                    <husk:SwitchCase Value="Remove">
                                                                        <Border
                                                                            Width="32"
                                                                            Height="32"
                                                                            VerticalAlignment="Top"
                                                                            Background="{StaticResource ControlDangerTranslucentHalfBackgroundBrush}"
                                                                            CornerRadius="16">
                                                                            <fi:SymbolIcon
                                                                                FontSize="{StaticResource MediumFontSize}"
                                                                                Foreground="{StaticResource ControlDangerForegroundBrush}"
                                                                                Symbol="Dismiss" />
                                                                        </Border>
                                                                    </husk:SwitchCase>
                                                                    <husk:SwitchCase Value="Update">
                                                                        <Border
                                                                            Width="32"
                                                                            Height="32"
                                                                            VerticalAlignment="Top"
                                                                            Background="{StaticResource ControlWarningTranslucentHalfBackgroundBrush}"
                                                                            CornerRadius="16">
                                                                            <fi:SymbolIcon
                                                                                FontSize="{StaticResource MediumFontSize}"
                                                                                Foreground="{StaticResource ControlWarningForegroundBrush}"
                                                                                Symbol="ArrowSort" />
                                                                        </Border>
                                                                    </husk:SwitchCase>
                                                                    <husk:SwitchCase Value="Unset">
                                                                        <Border
                                                                            Width="32"
                                                                            Height="32"
                                                                            VerticalAlignment="Top"
                                                                            Background="{StaticResource ControlAccentTranslucentHalfBackgroundBrush}"
                                                                            CornerRadius="16">
                                                                            <fi:SymbolIcon
                                                                                FontSize="{StaticResource MediumFontSize}"
                                                                                Foreground="{StaticResource ControlAccentForegroundBrush}"
                                                                                Symbol="Sparkle" />
                                                                        </Border>
                                                                    </husk:SwitchCase>
                                                                </husk:SwitchPresenter>

                                                                <!--  Bottom connector line  -->
                                                                <Rectangle
                                                                    Grid.Row="2"
                                                                    Width="2"
                                                                    HorizontalAlignment="Center"
                                                                    Fill="{StaticResource ControlBorderBrush}" />
                                                            </Grid>

                                                            <!--  Content column  -->
                                                            <Border
                                                                Grid.Column="1"
                                                                Margin="0,0,0,6"
                                                                Padding="12,8"
                                                                Background="{StaticResource ControlTranslucentHalfBackgroundBrush}"
                                                                CornerRadius="{StaticResource MediumCornerRadius}">
                                                                <Grid RowDefinitions="Auto,Auto" RowSpacing="4">
                                                                    <!--  Action description  -->
                                                                    <husk:SwitchPresenter
                                                                        Grid.Row="0"
                                                                        TargetType="m:InstancePackageModificationKind"
                                                                        Value="{Binding Kind}">
                                                                        <husk:SwitchCase Value="AddUnversioned">
                                                                            <TextBlock FontWeight="{StaticResource ControlStrongFontWeight}">
                                                                                <Run Text="{x:Static lang:Resources.InstancePackageModal_AddedLabelText}" />
                                                                                <InlineUIContainer BaselineAlignment="Bottom">
                                                                                    <Panel>
                                                                                        <Rectangle
                                                                                            RadiusX="4"
                                                                                            RadiusY="4"
                                                                                            Stroke="{StaticResource ControlBorderBrush}"
                                                                                            StrokeDashArray="4,2"
                                                                                            StrokeThickness="1" />
                                                                                        <TextBlock
                                                                                            Margin="6,2"
                                                                                            FontSize="{StaticResource ExtraSmallFontSize}"
                                                                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                                            Text="{x:Static lang:Resources.InstancePackageModal_AutoVersionLabelText}" />
                                                                                    </Panel>
                                                                                </InlineUIContainer>
                                                                            </TextBlock>
                                                                        </husk:SwitchCase>
                                                                        <husk:SwitchCase Value="AddVersioned">
                                                                            <TextBlock FontWeight="{StaticResource ControlStrongFontWeight}">
                                                                                <Run Text="{x:Static lang:Resources.InstancePackageModal_AddedLabelText}" />
                                                                                <Run Foreground="{StaticResource ControlAccentForegroundBrush}" Text="{Binding VersionName}" />
                                                                            </TextBlock>
                                                                        </husk:SwitchCase>
                                                                        <husk:SwitchCase Value="Remove">
                                                                            <TextBlock FontWeight="{StaticResource ControlStrongFontWeight}">
                                                                                <Run Text="{x:Static lang:Resources.InstancePackageModal_RemovedPackageText}" />
                                                                            </TextBlock>
                                                                        </husk:SwitchCase>
                                                                        <husk:SwitchCase Value="Update">
                                                                            <TextBlock FontWeight="{StaticResource ControlStrongFontWeight}">
                                                                                <Run Text="{x:Static lang:Resources.InstancePackageModal_UpdatedToLabelText}" />
                                                                                <Run Foreground="{StaticResource ControlAccentForegroundBrush}" Text="{Binding VersionName}" />
                                                                            </TextBlock>
                                                                        </husk:SwitchCase>
                                                                        <husk:SwitchCase Value="Unset">
                                                                            <TextBlock FontWeight="{StaticResource ControlStrongFontWeight}">
                                                                                <Run Text="{x:Static lang:Resources.InstancePackageModal_SetToLabelText}" />
                                                                                <InlineUIContainer BaselineAlignment="Bottom">
                                                                                    <Panel>
                                                                                        <Rectangle
                                                                                            RadiusX="4"
                                                                                            RadiusY="4"
                                                                                            Stroke="{StaticResource ControlBorderBrush}"
                                                                                            StrokeDashArray="4,2"
                                                                                            StrokeThickness="1" />
                                                                                        <TextBlock
                                                                                            Margin="6,2"
                                                                                            FontSize="{StaticResource ExtraSmallFontSize}"
                                                                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                                            Text="{x:Static lang:Resources.InstancePackageModal_AutoVersionLabelText}" />
                                                                                    </Panel>
                                                                                </InlineUIContainer>
                                                                            </TextBlock>
                                                                        </husk:SwitchCase>
                                                                    </husk:SwitchPresenter>

                                                                    <!--  Timestamp  -->
                                                                    <Grid
                                                                        Grid.Row="1"
                                                                        ColumnDefinitions="Auto,*"
                                                                        ColumnSpacing="6">
                                                                        <fi:SymbolIcon
                                                                            Grid.Column="0"
                                                                            VerticalAlignment="Center"
                                                                            FontSize="{StaticResource SmallFontSize}"
                                                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                            Symbol="Clock" />
                                                                        <TextBlock
                                                                            Grid.Column="1"
                                                                            VerticalAlignment="Center"
                                                                            Background="Transparent"
                                                                            FontSize="{StaticResource SmallFontSize}"
                                                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                                            Text="{Binding ModifiedAt}"
                                                                            ToolTip.Tip="{Binding ModifiedAtRaw}" />
                                                                    </Grid>
                                                                </Grid>
                                                            </Border>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            <husk:Tag Content="{x:Static lang:Resources.InstancePackageModal_PastTagText}" />
                                        </StackPanel>
                                    </ScrollViewer>
                                </Panel>
                            </DataTemplate>
                        </husk:LazyContainer.SourceTemplate>
                    </husk:LazyContainer>
                </TabItem>
            </TabControl>
            <Grid
                Grid.Row="2"
                ColumnDefinitions="Auto,*,Auto"
                ColumnSpacing="12">
                <Border
                    Grid.Column="0"
                    Padding="8,6"
                    Background="{StaticResource ControlTranslucentHalfBackgroundBrush}"
                    CornerRadius="{StaticResource MediumCornerRadius}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock VerticalAlignment="Center" Text="操作: " />
                        <husk:SwitchPresenter
                            IsVisible="False"
                            TargetType="x:Boolean"
                            Value="{Binding $parent[modals:InstancePackageModal].IsDeleting, Mode=OneWay}">
                            <husk:SwitchCase Value="{x:False}">
                                <Button
                                    Classes="Danger Small"
                                    Command="{Binding $parent[modals:InstancePackageModal].DeleteCommand}"
                                    Theme="{StaticResource OutlineButtonTheme}">
                                    <fi:SymbolIcon FontSize="{StaticResource SmallFontSize}" Symbol="Delete" />
                                </Button>
                            </husk:SwitchCase>
                            <husk:SwitchCase Value="{x:True}">
                                <Button
                                    Classes="Small"
                                    Command="{Binding $parent[modals:InstancePackageModal].UndeleteCommand}"
                                    Theme="{StaticResource OutlineButtonTheme}">
                                    <fi:SymbolIcon FontSize="{StaticResource SmallFontSize}" Symbol="ArrowReset" />
                                </Button>
                            </husk:SwitchCase>
                        </husk:SwitchPresenter>
                        <ToggleSwitch
                            IsChecked="{Binding Owner.IsEnabled, Mode=TwoWay}"
                            OffContent="{x:Static lang:Resources.Enum_Disabled}"
                            OnContent="{x:Static lang:Resources.Enum_Enabled}" />
                    </StackPanel>
                </Border>
                <StackPanel
                    Grid.Column="2"
                    Orientation="Horizontal"
                    Spacing="6">
                    <Button
                        Command="{Binding $parent[modals:InstancePackageModal].Dismiss}"
                        Content="{x:Static lang:Resources.Dialog_DismissButtonText}"
                        IsCancel="True" />
                </StackPanel>
            </Grid>
        </Grid>
    </husk:ConstrainedBox>
</husk:Modal>
