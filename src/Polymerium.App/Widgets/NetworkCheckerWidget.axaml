<local:WidgetBase
    x:Class="Polymerium.App.Widgets.NetworkCheckerWidget"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:Polymerium.App.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:husk="https://github.com/d3ara1n/Huskui.Avalonia"
    xmlns:local="clr-namespace:Polymerium.App.Widgets"
    xmlns:m="clr-namespace:Polymerium.App.Models"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Network Checker"
    d:DesignHeight="450"
    d:DesignWidth="800"
    Icon="NetworkCheck"
    mc:Ignorable="d">
    <local:WidgetBase.FullTemplate>
        <DataTemplate DataType="local:NetworkCheckerWidget">
            <DockPanel VerticalSpacing="12">
                <!--  操作按钮  -->
                <Button
                    HorizontalAlignment="Left"
                    Classes="Primary Small"
                    Command="{Binding PerformCommand}"
                    DockPanel.Dock="Top"
                    IsEnabled="{Binding !IsTesting}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding ButtonText}" />
                        <husk:ProgressRing
                            Width="16"
                            Height="16"
                            Background="{StaticResource ControlForegroundBrush}"
                            IsIndeterminate="True"
                            IsVisible="{Binding IsTesting}" />
                    </StackPanel>
                </Button>

                <!--  测试结果列表  -->
                <ScrollViewer>
                    <ItemsControl ItemsSource="{Binding Sites}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Spacing="6" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="m:ConnectionTestSiteModel">
                                <Border
                                    Margin="2"
                                    Background="{StaticResource OverlaySolidBackgroundBrush}"
                                    BoxShadow="0 2 4 0 #3F000000"
                                    CornerRadius="{StaticResource SmallCornerRadius}">
                                    <DockPanel>
                                        <!--  延迟进度条  -->
                                        <ProgressBar
                                            CornerRadius="{Binding CornerRadius, RelativeSource={RelativeSource FindAncestor, AncestorType=Border}, Converter={x:Static husk:CornerRadiusConverters.Lower}}"
                                            DockPanel.Dock="Bottom"
                                            IsIndeterminate="{Binding IsTesting}"
                                            Maximum="500"
                                            Value="{Binding Latency}">
                                            <ProgressBar.Background>
                                                <MultiBinding Converter="{x:Static converters:InternalConverters.LatencyToColorBrush}">
                                                    <Binding Path="Latency" />
                                                    <Binding Path="Status" />
                                                </MultiBinding>
                                            </ProgressBar.Background>
                                        </ProgressBar>

                                        <!--  内容区域  -->
                                        <Border Margin="8,4" CornerRadius="{Binding Source={StaticResource SmallCornerRadius}, Converter={x:Static husk:CornerRadiusConverters.Upper}}">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <!--  网站名称  -->
                                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Display}" />
                                                    <TextBlock
                                                        FontSize="{StaticResource SmallFontSize}"
                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                        Text="{Binding Endpoint}" />
                                                </StackPanel>

                                                <!--  状态显示  -->
                                                <StackPanel
                                                    Grid.Column="1"
                                                    Orientation="Horizontal"
                                                    Spacing="8">
                                                    <!--  延迟显示  -->
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                        IsVisible="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static m:ConnectionTestStatus.Success}}"
                                                        Text="{Binding Latency, StringFormat={}{0:F0}ms}" />

                                                    <!--  错误消息  -->
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        Foreground="{StaticResource ControlDangerForegroundBrush}"
                                                        IsVisible="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static m:ConnectionTestStatus.Failed}}"
                                                        Text="{Binding ErrorMessage}" />

                                                    <!--  等待中  -->
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                        IsVisible="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static m:ConnectionTestStatus.Pending}}"
                                                        Text="Waiting..." />

                                                    <!--  测试中  -->
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                                        IsVisible="{Binding IsTesting}"
                                                        Text="Testing..." />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DockPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>
        </DataTemplate>
    </local:WidgetBase.FullTemplate>

    <!--  Slim 模板：紧凑视图  -->
    <local:WidgetBase.SlimTemplate>
        <DataTemplate DataType="local:NetworkCheckerWidget">
            <Grid RowDefinitions="*,Auto" RowSpacing="8">
                <!--  简化的测试结果  -->
                <ScrollViewer Grid.Row="0">
                    <ItemsControl ItemsSource="{Binding Sites}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Spacing="4" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="m:ConnectionTestSiteModel">
                                <Grid Margin="4,2" ColumnDefinitions="*,Auto">
                                    <TextBlock
                                        Grid.Column="0"
                                        VerticalAlignment="Center"
                                        FontSize="12"
                                        Text="{Binding Display}" />

                                    <StackPanel
                                        Grid.Column="1"
                                        Orientation="Horizontal"
                                        Spacing="4">
                                        <!--  成功状态  -->
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            FontSize="11"
                                            Foreground="{StaticResource ControlSuccessForegroundBrush}"
                                            IsVisible="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static m:ConnectionTestStatus.Success}}"
                                            Text="{Binding Latency, StringFormat={}{0:F0}ms}" />

                                        <!--  失败状态  -->
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            FontSize="11"
                                            Foreground="{StaticResource ControlDangerForegroundBrush}"
                                            IsVisible="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static m:ConnectionTestStatus.Failed}}"
                                            Text="✗" />

                                        <!--  等待状态  -->
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            FontSize="11"
                                            Foreground="{StaticResource ControlSecondaryForegroundBrush}"
                                            IsVisible="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static m:ConnectionTestStatus.Pending}}"
                                            Text="—" />
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!--  操作按钮  -->
                <Button
                    Grid.Row="1"
                    HorizontalAlignment="Stretch"
                    Classes="Small"
                    Command="{Binding PerformCommand}"
                    IsEnabled="{Binding !IsTesting}">
                    <TextBlock Text="{Binding ButtonText}" />
                </Button>
            </Grid>
        </DataTemplate>
    </local:WidgetBase.SlimTemplate>
</local:WidgetBase>
